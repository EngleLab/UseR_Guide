# Messy to Tidy

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">

```{r include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE, message = FALSE, warning = FALSE)
```

```{r echo=FALSE, eval = TRUE}
knitr::include_graphics(rep("images/workflow.png"))
```

Stage 1 in the data processing workflow is **converting *messy* raw data files to *tidy* raw data files**. In this Chapter you will go over an example of how to write an R Script for this stage of data processing.

This part is not always fun and it can be very tempting to skip and go straight to creating a *scored* data file that is ready for data analysis. Because data analysis is the fun part! However, I strongly advise against that. There are at least a few good reasons why:

1) Sometimes you actually NEED the raw trial level data. For instance, to do reliability or internal consistency analyses. 

2) Visualizing and analyzing trial-level data can help you better understand your data.

3) You or some other researcher might want to go back and run analyses starting from the trial-level data. Maybe you/they want to score the data slightly differently than you did before. 

4) Data storage. Storing and sharing your data in a *tidy* raw data format makes SO MUCH more sense than storing your *messy* raw data. If working with your *messy* raw data gives you a headache now imagine how much worse that is when you have not thought about that data for a long time.

And so many other reasons

----

In the previous Chapter you should have downloaded the example Flanker data set, setup your directory organization, and created an RStudio Project. 

Go ahead and open the RStudio Project if you have not done so already.

----
<div style="text-align: center; font-size: 1.25em">
<i class="fas fa-save" style="font-size: 3em"></i> 

Save a new R script file as `1_flanker_raw.R` in the *R Scripts* folder

</div>
----

----
<div style="text-align: center; font-size: 1.25em">
<i class="fas fa-save" style="font-size: 3em"></i> 

Source the masterscript

</div>
----

After sourcing the masterscript you should see a new file in your project's *root* directory called `directiories.rds`. For now don't do anything with it but just be aware that it is there.

There are 4 sections to create in the script:

1) **Setup** 

2) **Import**

3) **Tidy**

4) **Output**

## Setup

In the *Setup* section we 1) load any packages, using `library()`, that are required for the script, 2) set the import/output filepaths and filenames, and 3) set any other parameters for the script. 

Let's go over how to create the setup section one piece at a time.

### Load packages

* `here`: You will use `here` to reference import and output file paths

* `readr`: You will use `readr` to import and export files

* `dplyr`: You will use `dplyr` to change the *messy* raw data file into a *tidy* raw data file

* `datawrangling`: You will use a function in this package to remove duplicate subject numbers in the *messy* raw data file.

At the top of your script write the following code (with commented sections)

```{r}
## Setup ####
## Load Packages
library(here)
library(readr)
library(dplyr)
library(datawrangling)
```

### Set Import/Output Directories

It is good practice to set the import and output directories at the top of your script. 

First, you need to import the file `directories.rds`. This is not standard, it is a method that is likely unique to me. I came up with it on my own. But I have found it useful to use `directories.rds` to manage file paths across different scripts within the same project. And it is pretty simple to use.

Let's see how this works. Import `directories.rds`

```{r}
directories <- readRDS(here("directories.rds"))
```

Now print the `directories` object to your console

```{r}
directories
```

You can see that `directories` is a *list* object that contains different filepaths. To access those file paths:

```{r}
directories$raw
```

Or

```{r}
directories$messy
```

These are *relative* file paths from the projects *root* directory. 

We can set the import and output file directories as such

```{r}
## Setup ####
## Load Packages
library(here)
library(readr)
library(dplyr)
library(datawrangling)

## Set Import/Output Directories
directories <- readRDS(here("directories.rds"))
import.dir <- directories$messy
output.dir <- directories$raw
```

### Set Import/Output File Names

Now set the import and output file names.

Let's output the *tidy* raw data files as **Flanker_raw.csv**.

```{r eval = TRUE}
## Setup ####
## Load Packages
library(here)
library(readr)
library(dplyr)
library(datawrangling)

## Set Import/Output Directories
directories <- readRDS(here("directories.rds"))
import.dir <- directories$messy
output.dir <- directories$raw

## Set Import/Output Filenames
import.file <- "Flanker.txt"
output.file <- "Flanker_raw.csv"
#############
```

That is all we need to include in the *Setup* block. Notice how I added some `####` on the top line after *Setup* and then included more `#############` at the very bottom of the *Setup* block, after the *Set Import/Output Filenames* section. This helps to organize your script by blocks. For instance, you can collapse all the code in the *Setup* block by clicking on the downward arrow/carrot to the right of *Setup*.

## Import

The next block of code is for importing the data file. 

After the *Setup* block add a section for the *Import* block 

```{r}
## Import ####

##############
```

You can import the *Flanker.txt* tab-delimited file using `read_delim()` from the `readr` package. To specificy the file path we can use the `here()` function from the `here` package. When you loaded the `here` package using `library(here)` it searched for a *.Rproj* file. Now when you use the function `here()` it will create a filepath to the directory where the *.Rproj* file is located, your projects *root* directory. Go ahead and type `here()` into the console.

```{r eval = FALSE}
library(here)
here()
```

To specify a filepath and filename in our *project* directory, we can use `here()`

```{r}
here("filepath", "filename")
```

Using the `import.dir` and `import.file` objects we created in the *Setup* block, this makes it really easy to specify the filepath and filename. 

```{r eval = TRUE}
here(import.dir, import.file)
```


```{r}
## Import ####
import <- read_delim(here(import.dir, import.file), 
                     "\t", escape_double = FALSE, trim_ws = TRUE)
##############
```

Now it happens on occasion that the wrong subject number is entered in when an RA is starting up a task. This can result in duplicate Subject numbers in the E-Merge file. Luckily I have created a function to remove the duplicate subjects, and put their information (with session date and time) into a specific file. This file will be created in a new folder called "duplicates".

The function is `duplicates_remove()` from the `datawrangling` package on my GitHub.

It can be difficult to remember what arguments you need to include in a function. To see helpful documentation about a function you can type in the console

```{r}
?duplicates_remove
```

```{r eval = TRUE}
## Import ####
import <- read_delim(here(import.dir, import.file), 
                     "\t", escape_double = FALSE, trim_ws = TRUE) %>%
  duplicates_remove(taskname = "Flanker", 
                    output.folder = here(output.dir))
##############
```

View the dataframe

```{r}
View(import)
```

It is a mess, right? Here are some things you need to know about the *messy* raw data file. These are the columns and what type of values they contain:

**Subject**: Subject number

**Procedure[Trial]**: Procedure type (keep: TrialProc and PracTrialProc)

**PracTrialList.Sample**: Trial number for practice trials

**TrialList.Sample**: Trial number for real trials

**FlankerType**: condition for real and practice trials (Values are: congruent, incongruent, and neutral)

**PracSlideTarget.RT**: Reaction time for practice trials

**PracSlideTarget.ACC**: Accuracy for practice trials

**PracSlideTarget.RESP**: Response for practice trials ({LEFTARROW} = left and {RIGHTARROW} = right)

**SlideTarget.RT**: Reaction time for real trials

**SlideTarget.ACC**: Accuracy for real trials

**SlideTarget.RESP**: Response for real trials ({LEFTARROW} = left and {RIGHTARROW} = right)

**TargerDirection**: direction of the target arrow for practice trials

**TargetDirection**: direction of the target arrow for real trials

**SessionDate**: Date of session

**SessionTime**: Time of session

## Tidy raw data

The next block is where we actually *tidy* the *messy* raw data. This basically involves filtering rows, renaming columns, changing values in columns, and selecting columns. And accordingly you will use these `dplyr` functions to do so:

* `filter()`

* `rename()`

* `mutate()`

* `select()`

This is why `dplyr` is so intuitive. The language of `dplyr` directly corresponds to how we think about working with data. 

Create a block for *tidying* the raw data after the *Import* block

```{r}
## Tidy raw data ####

#####################
```

### Filter

Filter only relevant rows. We want to keep only the rows that contain trials from the practice and real trials.

```{r}
## Tidy raw data ####
data_raw <- import %>%
  filter(`Procedure[Trial]`=="TrialProc" | `Procedure[Trial]`=="PracTrialProc")
#####################
```

The column names are contained in single quotes because the names contain the special characters `[ ]`. There are certain characters R does not like to use as variable names and one of them is square brackets.

### Rename Columns

Now the column specifying real vs practice trials is a little tedious to keep typing out since it requires the single quotes and brackets. To rename columns we can use `rename()` function in `dplyr`.

```{r warning=FALSE, collapse=TRUE, message=FALSE, eval = TRUE}
## Tidy raw data ####
data_raw <- import %>%
  filter(`Procedure[Trial]`=="TrialProc" | `Procedure[Trial]`=="PracTrialProc") %>%
  rename(TrialProc = `Procedure[Trial]`)
#####################
```

### Change Values

Chabge the values in `TrialProc`. 

```{r eval = TRUE}
unique(data_raw$TrialProc)
```

Right now real trials have the value of `TrialProc`. The same name as the column, not good! And the "practice" trials have the value of `PractTrialProc`. Let's simply change these values to `real` and `practice`, respectively. 

```{r eval = TRUE}
## Tidy raw data ####
data_raw <- import %>%
  filter(`Procedure[Trial]`=="TrialProc" | `Procedure[Trial]`=="PracTrialProc") %>%
  rename(TrialProc = `Procedure[Trial]`) %>%
  mutate(TrialProc = case_when(TrialProc == "TrialProc" ~ "real",
                               TrialProc == "PracTrialProc" ~ "practice"))
#####################
```

Evaluate that this worked

```{r eval = TRUE}
unique(data_raw$TrialProc)
```

Okay now let's move on to figuring out what other columns we want to keep and if we need to do any more computations on them.

We want to keep the columns that specify the following information

* Subject number
* TrialProc (real vs practice)
* Trial number 
* Condition (congruent vs incongruent)
* Reaction time
* Accuracy
* Response
* Target arrow direction (left or right)
* Session Date
* Session Time

This gets a little more tricky here because the information for some of these variables are in one column for practice trials and a different column for real trials. That means we need to merge the information from these two columns into one.

For instance the RT data for practice trials is contained in the column `PracSlideTarget.RT` and for real trials RT data is in `SlideTarget.RT`. We can create a new column labeled `RT` that on `real` trials, values are taken from the `SlideTarget.RT` column and on `practice` trials, values are taken from the `PracSlideTarget.RT` column.

```{r}
## Tidy raw data ####
data_raw <- import %>%
  filter(`Procedure[Trial]`=="TrialProc" | `Procedure[Trial]`=="PracTrialProc") %>%
  rename(TrialProc = `Procedure[Trial]`) %>%
  mutate(TrialProc = case_when(TrialProc == "TrialProc" ~ "real",
                               TrialProc == "PracTrialProc" ~ "practice"),
         RT = case_when(TrialProc == "real" ~ SlideTarget.RT,
                        TrialProc == "practice" ~ PracSlideTarget.RT))
#####################
```

We can do the same thing for trial, accuracy, response, and target arrow direction. Combining them all into one `mutate()` function

```{r}
## Tidy raw data ####
data_raw <- import %>%
  filter(`Procedure[Trial]`=="TrialProc" | 
           `Procedure[Trial]`=="PracTrialProc") %>%
  rename(TrialProc = `Procedure[Trial]`) %>%
  mutate(TrialProc = case_when(TrialProc == "TrialProc" ~ "real",
                               TrialProc == "PracTrialProc" ~ "practice"),
         RT = case_when(TrialProc == "real" ~ SlideTarget.RT,
                        TrialProc == "practice" ~ PracSlideTarget.RT),
         Trial = case_when(TrialProc == "real"     ~ TrialList.Sample,
                           TrialProc == "practice" ~ PracTrialList.Sample),
         Accuracy = case_when(TrialProc == "real" ~ SlideTarget.ACC,
                              TrialProc == "practice" ~ PracSlideTarget.ACC),
         Response = case_when(TrialProc == "real" ~ SlideTarget.RESP,
                              TrialProc == "practice" ~ PracSlideTarget.RESP),
         TargetArrowDirection = 
           case_when(TrialProc == "real" ~ TargetDirection,
                     TrialProc == "practice" ~ TargerDirection))
#####################
```

Notice how I sometimes put `case_when()` on a different line. This is just to make sure the code does not run too far off to the right so we do not have to horizontally scroll too much.

You might want to change the values in the Response and CorrectResponse columns to be more clear (left and right).

```{r}
## Tidy raw data ####
data_raw <- import %>%
  filter(`Procedure[Trial]`=="TrialProc" | 
           `Procedure[Trial]`=="PracTrialProc") %>%
  rename(TrialProc = `Procedure[Trial]`) %>%
  mutate(TrialProc = case_when(TrialProc == "TrialProc" ~ "real",
                               TrialProc == "PracTrialProc" ~ "practice"),
         RT = case_when(TrialProc == "real" ~ SlideTarget.RT,
                        TrialProc == "practice" ~ PracSlideTarget.RT),
         Trial = case_when(TrialProc == "real"     ~ TrialList.Sample,
                           TrialProc == "practice" ~ PracTrialList.Sample),
         Accuracy = case_when(TrialProc == "real" ~ SlideTarget.ACC,
                              TrialProc == "practice" ~ PracSlideTarget.ACC),
         TargetArrowDirection = 
           case_when(TrialProc == "real" ~ TargetDirection,
                     TrialProc == "practice" ~ TargerDirection),
         Response = case_when(TrialProc == "real" ~ SlideTarget.RESP,
                              TrialProc == "practice" ~ PracSlideTarget.RESP),
         Response = case_when(Response == "z" ~ "left",
                              Response == "{/}" ~ "right"))
#####################
```

### Select Columns

The last thing to do is select only the columns we want to keep. Remember we want to only select columns with the following information

* Subject number
* Trial number 
* Condition
* Reaction time
* Accuracy
* Response
* Correct Response
* Target arrow direction
* Session Date
* Session Time

```{r}
## Tidy raw data ####
data_raw <- import %>%
  filter(`Procedure[Trial]`=="TrialProc" | 
           `Procedure[Trial]`=="PracTrialProc") %>%
  rename(TrialProc = `Procedure[Trial]`) %>%
  mutate(TrialProc = case_when(TrialProc == "TrialProc" ~ "real",
                               TrialProc == "PracTrialProc" ~ "practice"),
         RT = case_when(TrialProc == "real" ~ SlideTarget.RT,
                        TrialProc == "practice" ~ PracSlideTarget.RT),
         Trial = case_when(TrialProc == "real"     ~ TrialList.Sample,
                           TrialProc == "practice" ~ PracTrialList.Sample),
         Accuracy = case_when(TrialProc == "real" ~ SlideTarget.ACC,
                              TrialProc == "practice" ~ PracSlideTarget.ACC),
         TargetArrowDirection = 
           case_when(TrialProc == "real" ~ TargetDirection,
                     TrialProc == "practice" ~ TargerDirection),
         Response = case_when(TrialProc == "real" ~ SlideTarget.RESP,
                              TrialProc == "practice" ~ PracSlideTarget.RESP),
         Response = case_when(Response == "z" ~ "left",
                              Response == "{/}" ~ "right")) %>%
  select(Subject, TrialProc, Trial, Condition = FlankerType, 
         RT, Accuracy, Response, TargetArrowDirection, 
         SessionDate, SessionTime)
#####################
```

And that is it for the *Tidy raw data* block! Almost done

## Output

The final block is to *Output* or Save the data file to your computer. This step is too easy

```{r}
## Output ####
write_csv(data_raw, here(output.dir, output.file))
##############
```

That's it! 

One last thing that is good to put at the end of every script.

```{r}
rm(list=ls())
```

This will remove all the objects from the current **Environment**. 

********

Then if we were to put it all together, using the template from the previous chapter:

```{r message = FALSE, warning = FALSE, collapse=TRUE}
## Setup ####
## Load Packages
library(here)
library(readr)
library(dplyr)
library(datawrangling)

## Set Import/Output Directories
directories <- readRDS(here("directories.rds"))
import.dir <- directories$messy
output.dir <- directories$raw

## Set Import/Output Filename
task <- "Flanker"
import.file <- paste(task, ".txt", sep = "")
output.file <- paste(task, "raw.csv", sep = "_")
#############

## Import ####
import <- read_delim(here(import.dir, import.file), 
                     "\t", escape_double = FALSE, trim_ws = TRUE) %>%
  duplicates_remove(taskname = task, 
                    output.folder = here(output.dir))
##############

## Tidy
## Tidy raw data ####
data_raw <- import %>%
  filter(`Procedure[Trial]`=="TrialProc" | 
           `Procedure[Trial]`=="PracTrialProc") %>%
  rename(TrialProc = `Procedure[Trial]`) %>%
  mutate(TrialProc = case_when(TrialProc == "TrialProc" ~ "real",
                               TrialProc == "PracTrialProc" ~ "practice"),
         RT = case_when(TrialProc == "real" ~ SlideTarget.RT,
                        TrialProc == "practice" ~ PracSlideTarget.RT),
         Trial = case_when(TrialProc == "real"     ~ TrialList.Sample,
                           TrialProc == "practice" ~ PracTrialList.Sample),
         Accuracy = case_when(TrialProc == "real" ~ SlideTarget.ACC,
                              TrialProc == "practice" ~ PracSlideTarget.ACC),
         TargetArrowDirection = 
           case_when(TrialProc == "real" ~ TargetDirection,
                     TrialProc == "practice" ~ TargerDirection),
         Response = case_when(TrialProc == "real" ~ SlideTarget.RESP,
                              TrialProc == "practice" ~ PracSlideTarget.RESP),
         Response = case_when(Response == "z" ~ "left",
                              Response == "{/}" ~ "right")) %>%
  select(Subject, TrialProc, Trial, Condition = FlankerType, 
         RT, Accuracy, Response, TargetArrowDirection, 
         SessionDate, SessionTime)
#####################

## Output ####
write_csv(data_raw, here(output.dir, output.file))
##############

rm(list=ls())
```

Great! You have written an R script for the first step in Data Preparation, converting a *messy* raw data file to a *tidy* raw data file. 

## Copy and Paste

Notice how pretty much everything except the *Tidy* block can be used from one task script to another. Besides the *Tidy* block, you basically would just have to change the `task`,  `import.file`, and `output.file` objects. The *Import* and *Output* blocks can literally be copy and pasted without changing anything at all.

The only thing that changes is what happens inside of `filter()`, `rename()`, `mutate()`, and `select()`. This means you can spend less time thinking about how you need to organize your script, and importing and outputing files. Instead, you can focus on the meat of the script, what happens in the *Tidy* block.

## Masterscript

Finally, you should add a line of code to the masterscript that *sources* the file **1_flanker_raw.R**.

```{r}
source(here("R Scripts", "1_flanker_raw.R"), echo = TRUE)
```


********

```{r echo=FALSE, message=FALSE, warning=FALSE, eval = TRUE}
rm(list=ls())
```

********

**Something**
